<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../fs-client/fs-client.html">
<link rel="import" href="../fs-behavior/fs-behavior.html">

<dom-module id="fs-request">
  <template>
    <fs-client name="{{clientName}}"></fs-client>
  </template>
  <script>
    /**
     * `fs-request`
     * 
     *     <fs-request url="{{boundUrl}}" on-response="{{responseHandler}}"></fs-request>
     * 
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class FSRequest extends Polymer.mixinBehaviors(FSBehavior, Polymer.Element) {
      
      static get is() { return 'fs-request'; }
      
      static get properties() {
        return {
          
          /** Whether requests should automatically be issued when request parameters change */
          auto: {
            type: Boolean,
            value: false
          },
          
          url: String,
          
          // TODO: support method, params, headers, contentType
          
          /** Whether a request is in flight */
          loading: {
            type: Boolean,
            value: false
          },
          
          /** Whether the request has completed */
          completed: {
            type: Boolean,
            value: false
          },
          
          /** Whether the request has been sent */
          sent: {
            type: Boolean,
            value: false
          },
          
          /** Whether the request has succeeded */
          succeeded: Boolean,
          
          /** Whether the request has failed */
          failed: Boolean
        };
      }
      
      static get observers() {
        return [
          '_requestOptionsChanged(auto, url)'
        ];
      }
      
      generateRequest() {
        this.loading = true;
        this.sent = true; // Not entirely true; this is at least one tick before it was sent
        
        this.getClient().get(this.url, (error, response) => {
          
          this.loading = false;
          this.completed = true;
          
          if(error) {
            this._handleError(error);
          } else {
            this._handleResponse(response);
          }
        });
      }
      
      _handleResponse(response) {
        this.failed = false;
        this.succeeded = true;
        this.fire('fs-request-response', { response }, {
          bubbles: this.bubbles,
          composed: true
        });
        this.fire('response', { response }, {
          bubbles: this.bubbles,
          composed: true
        });
      }
      
      _handleError(error) {
        this.succeeded = false;
        this.failed = true;
        this.fire('fs-request-error', { error }, {
          bubbles: this.bubbles,
          composed: true
        });
        this.fire('error', { error }, {
          bubbles: this.bubbles,
          composed: true
        });
      }
      
      _requestOptionsChanged() {
        if(this.url == null) {
          return;
        }
        if(this.auto) {
          this.generateRequest();
        }
      }
    }
  
    window.customElements.define(FSRequest.is, FSRequest);
  </script>
</dom-module>
